<!DOCTYPE html>
<html>
<head>
    <title>NKå†’é™©-å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        body { 
            text-align: center; 
            margin: 0; 
            padding: 20px;
            background: linear-gradient(to right, #ff9966, #ff5e62);
            font-family: Arial, sans-serif;
        }
        canvas {
            background: #87CEEB;
            border: 3px solid #333;
            margin-top: 10px;
            max-width: 100%;
        }
        #loading {
            padding: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            margin: 20px auto;
            max-width: 500px;
        }
        #progress-bar {
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        #progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>ğŸ¾ NKçš„å¤§å†’é™© ğŸµ</h1>
    <div id="loading">
        <h3>æ¸¸æˆåŠ è½½ä¸­...</h3>
        <div id="progress-bar">
            <div id="progress"></div>
        </div>
        <p id="status">åˆå§‹åŒ–ç¯å¢ƒ...</p >
        <p>é¦–æ¬¡åŠ è½½éœ€è¦çº¦1åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</p >
    </div>
    <canvas id="game" width="800" height="300"></canvas>
    <p>æ“ä½œï¼šç©ºæ ¼é”®è·³è·ƒ | æ‰‹æœºç‚¹å‡»å±å¹•</p >

    <script>
        async function startGame() {
            const updateStatus = (percent, msg) => {
                document.getElementById("progress").style.width = percent + "%";
                document.getElementById("status").textContent = msg;
            };

            try {
                // é˜¶æ®µ1ï¼šåŠ è½½Pyodide
                updateStatus(10, "åŠ è½½Pythonç¯å¢ƒ...");
                window.pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });

                // é˜¶æ®µ2ï¼šåŠ è½½Pygame
                updateStatus(30, "åŠ è½½æ¸¸æˆå¼•æ“...");
                await pyodide.loadPackage("pygame");

                // é˜¶æ®µ3ï¼šé¢„åŠ è½½èµ„æº
                updateStatus(50, "åŠ è½½æ¸¸æˆç´ æ...");
                await pyodide.runPython(`
                    import pygame
                    import io
                    from js import fetch

                    # åˆå§‹åŒ–æ··éŸ³å™¨
                    pygame.mixer.init()

                    # å¼‚æ­¥åŠ è½½èµ„æº
                    async def load_resource(url, resource_type):
                        response = await fetch(url)
                        if resource_type == "image":
                            return pygame.image.load(io.BytesIO(await response.arrayBuffer()))
                        elif resource_type == "sound":
                            sound_data = await response.arrayBuffer()
                            with open("temp.sound", "wb") as f:
                                f.write(sound_data.to_bytes())
                            return pygame.mixer.Sound("temp.sound")
                `);

                // é˜¶æ®µ4ï¼šè¿è¡Œæ¸¸æˆä¸»ä»£ç 
                updateStatus(80, "åˆå§‹åŒ–æ¸¸æˆ...");
                await pyodide.runPython(`
                    # åŠ è½½è¿œç¨‹èµ„æºï¼ˆæ›¿æ¢ä¸ºä½ çš„GitHubæ–‡ä»¶é“¾æ¥ï¼‰
                    player_img = await load_resource("https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/ä»“åº“å/main/player.png", "image")
                    obstacle_img = await load_resource("https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/ä»“åº“å/main/obstacle.png", "image")
                    jump_sound = await load_resource("https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/ä»“åº“å/main/jump.wav", "sound")

                    # æ¸¸æˆåˆå§‹åŒ–
                    pygame.init()
                    screen = pygame.display.set_mode((800, 300))
                    clock = pygame.time.Clock()

                    # æ¸¸æˆå‚æ•°
                    class Player:
                        def __init__(self):
                            self.rect = pygame.Rect(50, 200, 60, 80)
                            self.jump_power = -15
                            self.gravity = 0.5
                            self.velocity = 0
                            self.image = pygame.transform.scale(player_img, (60, 80))

                        def jump(self):
                            if self.rect.y >= 200:
                                self.velocity = self.jump_power
                                jump_sound.play()

                        def update(self):
                            self.velocity += self.gravity
                            self.rect.y += self.velocity
                            if self.rect.y > 200:
                                self.rect.y = 200
                                self.velocity = 0

                    # éšœç¢ç‰©ç±»
                    class Obstacle:
                        def __init__(self):
                            self.width = 40
                            self.height = random.randint(50, 100)
                            self.rect = pygame.Rect(800, 200-self.height, self.width, self.height)
                            self.image = pygame.transform.scale(obstacle_img, (self.width, self.height))

                    # æ¸¸æˆä¸»å¾ªç¯
                    player = Player()
                    obstacles = []
                    score = 0
                    running = True

                    while running:
                        # äº‹ä»¶å¤„ç†
                        for event in pygame.event.get():
                            if event.type == pygame.QUIT:
                                running = False

                        # é”®ç›˜æ§åˆ¶
                        keys = pygame.key.get_pressed()
                        if keys[pygame.K_SPACE]:
                            player.jump()

                        # æ¸¸æˆé€»è¾‘
                        if random.random() < 0.02:
                            obstacles.append(Obstacle())

                        for obs in obstacles[:]:
                            obs.rect.x -= 8
                            if obs.rect.colliderect(player.rect):
                                running = False
                            if obs.rect.x < -50:
                                obstacles.remove(obs)
                                score += 1

                        player.update()

                        # ç»˜åˆ¶
                        screen.fill((135, 206, 235))
                        pygame.draw.rect(screen, (139, 69, 19), (0, 200, 800, 100))
                        screen.blit(player.image, player.rect)
                        for obs in obstacles:
                            screen.blit(obs.image, obs.rect)

                        # æ˜¾ç¤ºåˆ†æ•°
                        font = pygame.font.SysFont(None, 36)
                        text = font.render(f"åˆ†æ•°: {score}", True, (0,0,0))
                        screen.blit(text, (10,10))

                        pygame.display.flip()
                        clock.tick(60)
                `);

                updateStatus(100, "åŠ è½½å®Œæˆï¼");
                setTimeout(() => {
                    document.getElementById("loading").style.display = "none";
                }, 1000);

            } catch (error) {
                document.getElementById("status").textContent = "åŠ è½½å¤±è´¥: " + error.message;
                console.error(error);
            }
        }

        // å¯åŠ¨æ¸¸æˆ
        startGame();

        // æ‰‹æœºè§¦æ‘¸æ§åˆ¶
        document.getElementById("game").addEventListener("click", () => {
            const event = new KeyboardEvent("keydown", { key: " " });
            document.dispatchEvent(event);
        });
    </script>
</body>
</html>
